name: QA Tests

on:
  deployment_status:

permissions:
  contents: read
  pull-requests: write
  deployments: read

jobs:
  test:
    # Only run when Vercel deployment succeeds
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: site

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: site/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ hashFiles('site/package-lock.json') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright system deps
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Copy curriculum.md for build
        run: cp ../curriculum.md . 2>/dev/null || true

      - name: Run Playwright tests
        id: tests
        run: npx playwright test 2>&1 | tee test-output.txt; echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
        env:
          DEPLOYMENT_URL: ${{ github.event.deployment_status.environment_url }}
          CI: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: site/playwright-report/
          retention-days: 14

      - name: Upload JSON results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: site/test-results/
          retention-days: 14

      - name: Post PR comment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOYMENT_URL: ${{ github.event.deployment_status.environment_url }}
        working-directory: ${{ github.workspace }}
        run: |
          SHA="${{ github.event.deployment.sha }}"
          PR_NUMBER=$(gh pr list --state open --json number,headRefOid --jq ".[] | select(.headRefOid == \"$SHA\") | .number" 2>/dev/null || echo "")

          if [ -z "$PR_NUMBER" ]; then
            echo "No open PR found for SHA $SHA â€” skipping comment"
            exit 0
          fi

          # Parse test results from JSON if available
          if [ -f site/test-results/results.json ]; then
            PASSED=$(jq '[.suites[].specs[].tests[] | select(.status == "expected")] | length' site/test-results/results.json 2>/dev/null || echo "?")
            FAILED=$(jq '[.suites[].specs[].tests[] | select(.status == "unexpected")] | length' site/test-results/results.json 2>/dev/null || echo "?")
            SKIPPED=$(jq '[.suites[].specs[].tests[] | select(.status == "skipped")] | length' site/test-results/results.json 2>/dev/null || echo "?")
          else
            PASSED="?"
            FAILED="?"
            SKIPPED="?"
          fi

          EXIT_CODE="${{ steps.tests.outputs.exit_code }}"
          if [ "$EXIT_CODE" = "0" ]; then
            STATUS="âœ… All tests passed"
            ICON="âœ…"
          else
            STATUS="âŒ Some tests failed"
            ICON="âŒ"
          fi

          BODY="## ðŸŽ­ QA Test Results ${ICON}

          **Status:** ${STATUS}
          **Tested URL:** ${DEPLOYMENT_URL}

          | Passed | Failed | Skipped |
          |--------|--------|---------|
          | ${PASSED} | ${FAILED} | ${SKIPPED} |

          [View full report â†’](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          gh pr comment "$PR_NUMBER" --body "$BODY" --edit-last 2>/dev/null || gh pr comment "$PR_NUMBER" --body "$BODY"

      - name: Fail if tests failed
        if: always() && steps.tests.outputs.exit_code != '0'
        run: exit 1
